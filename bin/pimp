#!/bin/bash
# pimp: pimp virtual environment to support setup/teardown
# Copyright (c) 2024 Bluenetics GmbH
# SPDX-License-Identifier: Apache-2.0

#===============================================================================
# pimp -?;  pimp --help   # show usage
#===============================================================================

   if [ "$*" == "-?" ] || [ "$*" == "--help" ] || [ "$*" == "--?" ]; then
      pimp ---g   "pimp virtual environment (version `pimp --version`)"
      pimp ---y   'usage: pimp [-ci?] [--<opt>] [<venv>] [<bin>]'
      echo        '  pimp                       # pimp, consign and install files in virtual environment'
      echo        '  pimp -c                    # consign files according to .pimp/consign list'
      echo        '  pimp -i                    # install consigned files in virtual environment'
      echo        '  pimp -d                    # consign and deploy binaries to $BIN directory'
      echo        '  pimp @venv                 # pimp @venv to support setup/teardown'
      echo        '  pimp @venv .pimp/bin       # also install binaries of .pimp/bin in @venv'
      echo        '  pimp -?                    # show usage'
      echo        '  pimp --help                # comprehensive help'
      echo        '  pimp --version             # print version'
      if [ "$*" != "-?" ]; then
        pimp ---y "more commands"
        echo      '  pimp --check @venv         # check if @venv is already pimped'
        echo      '  pimp --consign             # consign binaries and set x-permissions to .pimp/bin'
        echo      '  pimp --install             # install pimp in $BIN directory'
        echo      '  pimp --install pimp <bin>  # install pimp in <bin> directory'
        echo      '  pimp --path <dir>          # examine path of directory in upward hierarchy'
        echo      '  pimp --pimp @venv          # actually pimp @venv'
        echo      '  pimp --copy @venv <bin>    # set x-permissions & copy <bin> files to @venv/bin'
      fi
      exit  0
   fi

#===============================================================================
# pimp --version   # print version
#===============================================================================

   if [ "$*" == "--version" ] || [ "$*" == "--v" ]; then
      echo "1.0.0a"; exit 0
   fi

#===============================================================================
# pimp --path <dir>   # examine path of directory in upward hierarchy
#===============================================================================

   if [ "$1" == "--path" ] && [ "$3" == "" ]; then
      DIR=`pwd`/$2
      #ec -g "DIR=$DIR"
      if [ -d "$DIR" ]; then
         echo $DIR
         exit 0
      fi

      if [ "`pwd`" == "/" ]; then
         exit 1
      fi

      cd ..
      pimp --path $2 || exit 1
      exit 0
   fi

#===============================================================================
# pimp --consign   # consign binaries and set x-permissions to .pimp/bin
#===============================================================================

   if [ "$*" == "--consign" ]; then
      PIMP=`pimp --path .pimp` || exit 1

      if [ ! -f "$PIMP/consign" ]; then
         pimp ---r "error: pimp $*" >&2
         echo      "       missing consignment file: $PIMP/consign" >&2
         exit 1
      fi

      if [ ! -d "$PIMP/bin" ]; then
         mkdir $PIMP/bin || exit 1
      fi

         # consign files listed in consignment file

      pimp ---g "=== consigning files (=> $PIMP/bin)"

      ROOT=${PIMP%"/.pimp"}
      FILES=`cat $PIMP/consign`

      for FILE in $FILES
      do
         echo "  $FILE -> $PIMP/bin"
         ERR=0
         cp $ROOT/$FILE $PIMP/bin/ || ERR=1
         if [ "$ERR" != "0" ]; then
            pimp ---r "error: pimp $*" >&2
            echo      "       unable to consign file: $FILE" >&2
         fi
      done
      exit 0
   fi

#===============================================================================
# pimp --install <pimp> [<bin>]  # install pimp in <bin> or $BIN directory
#===============================================================================

   if [ "$1" == "--install" ] && [ "$2" != "" ] && [ "$4" == "" ]; then
      shift

      if [ "$1" == "" ]; then
         pimp --consign || exit 1
         exit 0
      fi

      if [ "$2" != "" ]; then   # <bin> arg provided!
         BIN=$2
      else
         if [ "$BIN" == "" ]; then
            pimp ---r "error: pimp $*" >&2
            echo      '       environment variable BIN=$BIN' >&2
            echo      '       consider to set something similar to: $ export BIN=~/bin' >&2
            exit 1
         fi
      fi

         # check that $BIN is a directory

      if [ ! -d "$BIN" ]; then
         pimp ---r "error: pimp $*" >&2
         echo      "       no directory: BIN=$BIN" >&2
         exit 1
      fi

         # check that arg1 is a file

      if [ ! -f "$1" ]; then
         pimp ---r "error: pimp $*" >&2
         echo      "       arg1 is not denoting a file: $1" >&2
         exit 1
      fi

         # everything good - install!

      pimp ---g "=== installing $1 in $BIN" >&2
      cp $1 $BIN || exit 1
      chmod +x $BIN/pimp || exit 1
      exit 0
   fi

##===============================================================================
# pimp ---r 'text arg'   # internal helper: echo in red color
# pimp ---g 'text arg'   # internal helper: echo in green color
# pimp ---y 'text arg'   # internal helper: echo in yellow color
#===============================================================================

   if [ "$1" == "---r" ]; then
      printf "\x1b[31m";  shift;  echo "$*";  printf "\x1b[0m"
      exit 0
   fi

   if [ "$1" == "---g" ]; then
      printf "\x1b[32m";  shift;  echo "$*";  printf "\x1b[0m"
      exit 0
   fi

   if [ "$1" == "---y" ]; then
      printf "\x1b[33m";  shift;  echo "$*";  printf "\x1b[0m"
      exit 0
   fi

#===============================================================================
# cannot deal with anything else ...
#===============================================================================

   printf "\x1b[31m";
   echo "bad command: pimp $*";  printf "\x1b[0m"
   echo '             for help invoke: pimp --help'
   exit 1
